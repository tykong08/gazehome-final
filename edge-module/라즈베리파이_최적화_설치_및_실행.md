# ë¼ì¦ˆë² ë¦¬íŒŒì´ GazeHome ìµœì í™” ì„¤ì¹˜ ë° ì‹¤í–‰ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

ì´ ê°€ì´ë“œëŠ” ë‘ ê°€ì§€ MediaPipe ì„¤ì¹˜ ë°©ë²•ì„ ë¶„ì„í•˜ì—¬, uv íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•˜ë©´ì„œë„ ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ì‘ë™í•˜ëŠ” ìµœì í™”ëœ ì„¤ì¹˜ ë°©ë²•ì„ ì œì‹œí•©ë‹ˆë‹¤.

---

## ğŸ” ê¸°ì¡´ ë°©ë²• ë¶„ì„

### ë°©ë²• 1ì˜ ì¥ì 
- MediaPipe RPI íŠ¹í™” íŒ¨í‚¤ì§€ ì‚¬ìš© (arm64 ìµœì í™”)
- ë” ë¹ ë¥¸ ì„±ëŠ¥
- ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ í™œìš© (python3-opencv)

### ë°©ë²• 2ì˜ ì¥ì 
- í‘œì¤€ MediaPipe íŒ¨í‚¤ì§€ ì‚¬ìš© (ë²„ì „ ì—…ë°ì´íŠ¸ ìš©ì´)
- protobuf í˜¸í™˜ì„± ëª…ì‹œ (ì˜ì¡´ì„± ë¬¸ì œ í•´ê²°)
- ë” ë§ì€ ì˜¨ë¼ì¸ ì§€ì› ìë£Œ

### ìµœì í™”ëœ ë°©ì‹
ë‘ ë°©ë²•ì˜ ì¥ì ì„ ê²°í•©í•˜ë˜, **uvì™€ venvë¥¼ ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš©**í•˜ì—¬ ì‹œìŠ¤í…œ Python ë³´í˜¸ì™€ íŒ¨í‚¤ì§€ ê´€ë¦¬ë¥¼ ë™ì‹œì— ë‹¬ì„±í•©ë‹ˆë‹¤.

---

## ğŸš€ ë‹¨ê³„ë³„ ì„¤ì¹˜ ê°€ì´ë“œ

### Step 1: ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° ê¸°ë³¸ íŒ¨í‚¤ì§€

```bash
# SSH ì ‘ì†
ssh gaze@raspberrypi.local

# ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
sudo apt update
sudo apt upgrade -y

# ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
sudo apt install -y git python3-pip python3-venv python3-dev python3-full

# ê°œë°œ ë„êµ¬ ì„¤ì¹˜
sudo apt install -y build-essential cmake pkg-config
```

**ì„¤ëª…**: `python3-full`ì€ ì‹œìŠ¤í…œ Python ë³´í˜¸ í•´ì œë¥¼ ìœ„í•´ í•„ìˆ˜ì…ë‹ˆë‹¤. ì´ë¥¼ ì„¤ì¹˜í•´ì•¼ venv ì—†ì´ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì œí•œì„ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

### Step 2: Rust ë° uv ì„¤ì¹˜

```bash
# Rust ì„¤ì¹˜ (uv ì˜ì¡´ì„±)
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# ì„¤ì¹˜ ì™„ë£Œ í›„ í™˜ê²½ ë¡œë“œ
source $HOME/.cargo/env

# uv ì„¤ì¹˜
curl -LsSf https://astral.sh/uv/install.sh | sh

# PATH ì„¤ì • (ì˜êµ¬ì )
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
echo 'source $HOME/.cargo/env' >> ~/.bashrc

# í˜„ì¬ ì„¸ì…˜ì— ì ìš©
source ~/.bashrc

# ì„¤ì¹˜ í™•ì¸
uv --version
rustc --version
```

---

### Step 3: ë¯¸ë””ì–´ ë° OpenCV ì˜ì¡´ì„±

```bash
# FFmpeg ì„¤ì¹˜
sudo apt install -y ffmpeg

# OpenCV ì˜ì¡´ì„± (ë°©ë²• 1 ì°¸ê³ )
sudo apt install -y libxcb-shm0 libcdio-paranoia-dev libsdl2-2.0-0 libxv1 \
  libtheora0 libva-drm2 libva-x11-2 libvdpau1 libharfbuzz0b \
  libbluray2 libatlas-base-dev libhdf5-dev libgtk-3-0

# protobuf ì„¤ì¹˜ (ë°©ë²• 2 ì°¸ê³  - ì¶©ëŒ ë°©ì§€)
sudo apt install -y libprotobuf-dev protobuf-compiler
```

**ì„¤ëª…**: ë‘ ë°©ë²• ëª¨ë‘ì˜ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•˜ì—¬ í˜¸í™˜ì„±ì„ ìµœëŒ€í™”í•©ë‹ˆë‹¤.

---

### Step 4: í”„ë¡œì íŠ¸ ì¤€ë¹„

```bash
# í”„ë¡œì íŠ¸ í´ë¡ 
cd ~
git clone https://github.com/ESWC-AIRIS/edge-module.git
cd edge-module

# develop ë¸Œëœì¹˜ í™•ì¸
git checkout develop
git pull origin develop

# ë””ë ‰í† ë¦¬ í™•ì¸
ls -la
```

---

### Step 5: Virtual Environment ìƒì„± (uv ì‚¬ìš©)

```bash
# uvë¡œ venv ìƒì„± (system-site-packages í¬í•¨)
uv venv --python 3.11 --system-site-packages

# í™œì„±í™”
source .venv/bin/activate

# í™•ì¸
which python
python --version
```

**ì„¤ëª…**: `--system-site-packages`ëŠ” ì‹œìŠ¤í…œì— ì„¤ì¹˜ëœ python3-opencv ë“±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

---

### Step 6: MediaPipe ì„¤ì¹˜ (ìµœì í™” ë°©ì‹)

```bash
# í˜„ì¬ venvê°€ í™œì„±í™”ëœ ìƒíƒœ í™•ì¸
source .venv/bin/activate

# ë°©ë²• A: MediaPipe RPI4 íŠ¹í™” íŒ¨í‚¤ì§€ (ê¶Œì¥)
pip install mediapipe-rpi4

# ë˜ëŠ”

# ë°©ë²• B: í‘œì¤€ MediaPipe + protobuf í˜¸í™˜ì„± ë³´ì¥
pip install protobuf==3.20
pip install mediapipe

# ì„¤ì¹˜ í™•ì¸
python -c "import mediapipe; print(f'âœ… MediaPipe {mediapipe.__version__}')"
```

**ì„¤ëª…**: ë°©ë²• AëŠ” ì„±ëŠ¥ì´ ìš°ìˆ˜í•˜ê³ , ë°©ë²• BëŠ” í˜¸í™˜ì„±ì´ ë›°ì–´ë‚©ë‹ˆë‹¤. í”„ë¡œì íŠ¸ëŠ” ë‘˜ ë‹¤ ì§€ì›í•©ë‹ˆë‹¤.

---

### Step 7: í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜

```bash
# venv í™œì„±í™” ìƒíƒœ ìœ ì§€
source .venv/bin/activate

# ë°©ë²• 1: uv sync (ê¶Œì¥)
uv sync

# ë˜ëŠ”

# ë°©ë²• 2: pip + requirements.txt
pip install -r requirements.txt

# ì„¤ì¹˜ í™•ì¸
python -c "from backend.core.gaze_tracker import WebGazeTracker; print('âœ… GazeTracker ì„í¬íŠ¸ ì„±ê³µ')"
```

---

### Step 8: í™˜ê²½ ì„¤ì • íŒŒì¼

```bash
# ë°±ì—”ë“œ ì„¤ì • íŒŒì¼ ìƒì„±
mkdir -p ~/.gazehome/calibrations

cat > backend/.env << 'EOF'
# AI ì„œë²„ ì„¤ì •
AI_SERVER_URL=http://34.227.8.172:8000
AI_REQUEST_TIMEOUT=60
AI_MAX_RETRIES=3

# Gateway ì„¤ì •
GATEWAY_URL=http://34.227.8.172:8001
GATEWAY_DEVICES_ENDPOINT=http://34.227.8.172:8001/api/lg/devices

# ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
DATABASE_PATH=/home/gaze/.gazehome/calibrations/gazehome.db
CALIBRATION_DIR=/home/gaze/.gazehome/calibrations

# ì„œë²„ ì„¤ì •
HOST=0.0.0.0
PORT=8000

# ë¼ì¦ˆë² ë¦¬íŒŒì´ ìµœì í™”
DEBUG=false
LOG_LEVEL=info
EOF
```

---

### Step 9: í”„ë¡ íŠ¸ì—”ë“œ ì„¤ì¹˜

```bash
# Node.js ì„¤ì¹˜ (ìµœì´ˆ 1íšŒ)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
cd frontend
npm install
npm run build

# í™•ì¸
ls -la dist/
```

---

## ğŸ¯ ì‹¤í–‰ ë°©ë²•

### ë°±ì—”ë“œ ì‹¤í–‰ (2ê°€ì§€ ë°©ë²•)

#### ë°©ë²• 1: uv run ì‚¬ìš©

```bash
cd ~/edge-module
source .venv/bin/activate
uv run run.py

# ë˜ëŠ”
uv run uvicorn backend.api.main:app --host 0.0.0.0 --port 8000
```

#### ë°©ë²• 2: ì§ì ‘ Python ì‹¤í–‰

```bash
cd ~/edge-module
source .venv/bin/activate
python backend/run.py

# ë˜ëŠ”
uvicorn backend.api.main:app --host 0.0.0.0 --port 8000
```

**ì¤‘ìš”**: `--host 0.0.0.0`ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ AI-Serverì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

---

### í”„ë¡ íŠ¸ì—”ë“œ ì‹¤í–‰

```bash
# ìƒˆ í„°ë¯¸ë„ì—ì„œ
cd ~/edge-module/frontend

# í”„ë¡œë•ì…˜ ëª¨ë“œ (ê¶Œì¥)
npm run build
npx serve -s dist -l 5173 --host 0.0.0.0

# ë˜ëŠ” ê°œë°œ ëª¨ë“œ
npm run dev -- --host 0.0.0.0
```

---

### ìµœì¢… í™•ì¸

```bash
# 1. ë¡œì»¬ ì ‘ì† í…ŒìŠ¤íŠ¸
curl http://localhost:8000/health
curl http://localhost:5173/

# 2. ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ ì ‘ì† í…ŒìŠ¤íŠ¸ (ê°™ì€ ë„¤íŠ¸ì›Œí¬ì˜ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ)
curl http://raspberrypi.local:8000/health
curl http://raspberrypi.local:5173/

# 3. ì¹´ë©”ë¼ í™•ì¸
python -c "import cv2; cap = cv2.VideoCapture(0); print('âœ… ì¹´ë©”ë¼ OK' if cap.isOpened() else 'âŒ ì¹´ë©”ë¼ ì‹¤íŒ¨')"

# 4. ì‹œì„  ì¶”ì  ì—”ì§„ í™•ì¸
python -c "from backend.core.gaze_tracker import WebGazeTracker; print('âœ… GazeTracker ì •ìƒ')"
```

---

## ğŸ”— AI-Serverì—ì„œ ì ‘ê·¼

AI-Server (EC2)ì—ì„œ ë¼ì¦ˆë² ë¦¬íŒŒì´ì˜ GazeHomeì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.

### ë°±ì—”ë“œ API ì ‘ê·¼

```python
# AI-Server ì½”ë“œ ì˜ˆì‹œ
import requests

RPi_IP = "raspberrypi.local"  # ë˜ëŠ” ì‹¤ì œ IP ì£¼ì†Œ
RPi_PORT = 8000

# ê¸°ê¸° ì¡°íšŒ
response = requests.get(f"http://{RPi_IP}:{RPi_PORT}/api/devices")
devices = response.json()

# ì¶”ì²œ ì „ì†¡
recommendation = {
    "title": "ì—ì–´ì»¨ ì¼œê¸°",
    "contents": "ê±°ì‹¤ì´ ë”ì›Œìš”",
    "actions": [{"action": "air_on", "delay_seconds": 0}]
}
requests.post(f"http://{RPi_IP}:{RPi_PORT}/api/recommendations", json=recommendation)
```

### ë°©í™”ë²½ ì„¤ì • (í•„ìš”ì‹œ)

```bash
# ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œ
sudo ufw allow 8000/tcp
sudo ufw allow 5173/tcp
sudo ufw enable
```

---

## ğŸ› ï¸ ë¬¸ì œ í•´ê²°

### MediaPipe import ì‹¤íŒ¨

```bash
# í˜„ì¬ venv í™œì„±í™” í™•ì¸
source .venv/bin/activate
which python

# ë°©ë²• A: MediaPipe-RPI4 ì¬ì„¤ì¹˜
pip uninstall mediapipe-rpi4 -y
pip install mediapipe-rpi4

# ë°©ë²• B: í‘œì¤€ MediaPipe + protobuf
pip uninstall mediapipe protobuf -y
pip install protobuf==3.20
pip install mediapipe

# ë²„ì „ í™•ì¸
pip show mediapipe
pip show protobuf
```

### externally-managed-environment ì˜¤ë¥˜

```bash
# âŒ ì˜ëª»ëœ ë°©ë²•
sudo pip install mediapipe

# âœ… ì˜¬ë°”ë¥¸ ë°©ë²• 1: venv í™œì„±í™”
source .venv/bin/activate
pip install mediapipe-rpi4

# âœ… ì˜¬ë°”ë¥¸ ë°©ë²• 2: venv ê²½ë¡œ ì§ì ‘ ì‚¬ìš©
~/.venv/bin/pip install mediapipe-rpi4

# âœ… ì˜¬ë°”ë¥¸ ë°©ë²• 3: uv ì‚¬ìš©
uv pip install mediapipe-rpi4
```

### í¬íŠ¸ ì´ë¯¸ ì‚¬ìš© ì¤‘

```bash
# í¬íŠ¸ ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì°¾ê¸°
lsof -i :8000
lsof -i :5173

# í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
kill -9 <PID>

# ë˜ëŠ” ë‹¤ë¥¸ í¬íŠ¸ ì‚¬ìš©
uvicorn backend.api.main:app --host 0.0.0.0 --port 8001
```

### ì¹´ë©”ë¼ ì¸ì‹ ì•ˆ ë¨

```bash
# ì¹´ë©”ë¼ í™•ì¸
ls -l /dev/video*

# v4l2 ë„êµ¬ë¡œ í…ŒìŠ¤íŠ¸
sudo apt install -y v4l-utils
v4l2-ctl --list-devices

# Pythonì—ì„œ ì¹´ë©”ë¼ í…ŒìŠ¤íŠ¸
python << EOF
import cv2
cap = cv2.VideoCapture(0)
if cap.isOpened():
    ret, frame = cap.read()
    print(f"âœ… ì¹´ë©”ë¼ OK - í•´ìƒë„: {frame.shape}")
else:
    print("âŒ ì¹´ë©”ë¼ ì‹¤íŒ¨")
cap.release()
EOF
```

---

## ğŸ“ systemd ì„œë¹„ìŠ¤ ë“±ë¡ (ì„ íƒì‚¬í•­)

ìë™ ì‹œì‘ì„ ì›í•˜ëŠ” ê²½ìš°:

```bash
# ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ìƒì„±
sudo nano /etc/systemd/system/gazehome-backend.service
```

```ini
[Unit]
Description=GazeHome Backend Service
After=network.target

[Service]
Type=simple
User=gaze
WorkingDirectory=/home/gaze/edge-module
Environment="PATH=/home/gaze/.venv/bin:/home/gaze/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin"
ExecStart=/home/gaze/.venv/bin/python backend/run.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ìƒì„±
sudo nano /etc/systemd/system/gazehome-frontend.service
```

```ini
[Unit]
Description=GazeHome Frontend Service
After=network.target

[Service]
Type=simple
User=gaze
WorkingDirectory=/home/gaze/edge-module/frontend
ExecStart=/usr/bin/npx serve -s dist -l 5173 --host 0.0.0.0
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# ì„œë¹„ìŠ¤ í™œì„±í™”
sudo systemctl daemon-reload
sudo systemctl enable gazehome-backend
sudo systemctl enable gazehome-frontend

# ì‹œì‘
sudo systemctl start gazehome-backend
sudo systemctl start gazehome-frontend

# ìƒíƒœ í™•ì¸
sudo systemctl status gazehome-backend
sudo systemctl status gazehome-frontend

# ë¡œê·¸ í™•ì¸
sudo journalctl -u gazehome-backend -f
```

---

## âœ… ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Rust + uv ì„¤ì¹˜
- [ ] FFmpeg ë° ì˜ì¡´ì„± ì„¤ì¹˜
- [ ] MediaPipe ì„¤ì¹˜ (ë°©ë²• A ë˜ëŠ” B)
- [ ] í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
- [ ] í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„±
- [ ] í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
- [ ] ë°±ì—”ë“œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
- [ ] í”„ë¡ íŠ¸ì—”ë“œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
- [ ] ì¹´ë©”ë¼ í™•ì¸
- [ ] ì‹œì„  ì¶”ì  ì—”ì§„ í…ŒìŠ¤íŠ¸
- [ ] AI-Serverì—ì„œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸

---

## ğŸ¯ ìš”ì•½

ì´ ë°©ì‹ì€ ë‘ ê°€ì§€ ê¸°ì¡´ ì„¤ì¹˜ ë°©ë²•ì˜ ì¥ì ì„ ëª¨ë‘ í™œìš©í•©ë‹ˆë‹¤:
- **ë°©ë²• 1ì˜ ì¥ì **: MediaPipe-RPI4 ìµœì í™” íŒ¨í‚¤ì§€ ì‚¬ìš© ì˜µì…˜
- **ë°©ë²• 2ì˜ ì¥ì **: protobuf í˜¸í™˜ì„± ëª…ì‹œì  ê´€ë¦¬

ë™ì‹œì— **uv íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €**ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš©í•˜ì—¬:
- âœ… ì‹œìŠ¤í…œ Python ë³´í˜¸ (venv ì‚¬ìš©)
- âœ… íŒ¨í‚¤ì§€ ê´€ë¦¬ ê°„í¸ì„± (uv sync)
- âœ… í™˜ê²½ ì¬í˜„ì„± (pyproject.toml + uv.lock)
- âœ… ë¼ì¦ˆë² ë¦¬íŒŒì´ ì•ˆì •ì„± (system-site-packages)

ê²°ê³¼ì ìœ¼ë¡œ **ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰**ë˜ë©´ì„œ **AI-Serverì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥**í•œ ì™„ì „í•œ GazeHome ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
