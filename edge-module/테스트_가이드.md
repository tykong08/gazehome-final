# 테스트 가이드

## 📋 개요

GazeHome 시스템 테스트를 위한 데이터 관리 스크립트 가이드입니다.

## 🛠️ 제공되는 스크립트

### 1. `check_db_status.py` - DB 상태 확인

**기능**:
- DB 파일 존재 여부 및 크기 확인
- 테이블별 레코드 수 확인
- 사용자, 보정, 기기, 액션 상세 정보 출력
- .pkl 보정 파일 목록 확인

**사용법**:
```bash
uv run check_db_status.py
# 또는
python check_db_status.py
```

**출력 예시**:
```
📊 GazeHome DB 상태 확인
├─ 데이터 디렉토리: /home/pi/.gazehome/calibrations
├─ users: 1개
├─ calibrations: 2개
├─ devices: 2개
└─ device_actions: 8개
```

---

### 2. `reset_calibration.py` - 보정 데이터만 초기화

**기능**:
- ✅ `calibrations` 테이블 레코드 삭제
- ✅ `.pkl` 보정 파일 삭제
- ❌ 기기 목록 유지
- ❌ 액션 데이터 유지
- ❌ 사용자 정보 유지

**사용법**:
```bash
uv run reset_calibration.py
# 또는
python reset_calibration.py
```

**언제 사용하나요?**
- 보정을 다시 테스트하고 싶을 때
- 기기 2개는 그대로 사용하면서 온보딩 플로우만 테스트할 때
- 보정 알고리즘 변경 후 재테스트할 때

**실행 후**:
- 다음 실행 시 온보딩 페이지부터 시작
- 보정 페이지로 이동
- 기기 목록은 이미 DB에 저장되어 있음

---

### 3. `reset_all_data.py` - 전체 데이터 초기화

**기능**:
- ✅ DB 파일 완전 삭제 (`gazehome.db`)
- ✅ 모든 `.pkl` 보정 파일 삭제
- ✅ 디렉토리 재생성 (빈 상태)

**사용법**:
```bash
uv run reset_all_data.py
# 또는
python reset_all_data.py
```

**언제 사용하나요?**
- 완전히 처음부터 다시 시작할 때
- DB 스키마 변경 후 재생성이 필요할 때
- 기기 목록을 다시 가져와야 할 때

**실행 후**:
- 다음 실행 시 DB가 자동으로 재생성됨
- 기기 데이터는 Gateway에서 다시 가져옴
- 온보딩부터 모든 과정 재진행

**⚠️ 주의**: 삭제 전 확인 프롬프트가 표시됩니다.

---

## 🔄 일반적인 테스트 워크플로우

### 시나리오 1: 보정만 다시 테스트 (기기 유지)

```bash
# 1. 현재 상태 확인
uv run check_db_status.py

# 2. 보정만 초기화
uv run reset_calibration.py

# 3. 백엔드 실행
uv run run.py

# 4. 프론트엔드 실행 (새 터미널)
cd frontend && npm run dev

# 5. 브라우저 접속
# http://localhost:5173
# → 온보딩 → 보정 → 홈 (기기 2개 이미 있음)

# 6. 테스트 후 상태 확인
uv run check_db_status.py
```

---

### 시나리오 2: 완전히 처음부터 시작

```bash
# 1. 전체 데이터 삭제
uv run reset_all_data.py
# → y 입력하여 확인

# 2. 백엔드 실행
uv run run.py
# → DB 자동 재생성

# 3. 프론트엔드 실행 (새 터미널)
cd frontend && npm run dev

# 4. 브라우저 접속
# http://localhost:5173
# → 온보딩 → 보정 → 홈 (기기 목록 Gateway에서 가져옴)

# 5. 상태 확인
uv run check_db_status.py
```

---

### 시나리오 3: 기기 2개만 계속 사용하며 반복 테스트

```bash
# 첫 실행 (기기 데이터 가져오기)
uv run run.py  # 백엔드 시작
cd frontend && npm run dev  # 프론트엔드 시작
# 브라우저에서 온보딩 → 보정 → 홈 진행
# → 기기 2개 DB에 저장됨

# 이후 테스트마다 반복
uv run reset_calibration.py  # 보정만 초기화
uv run run.py  # 백엔드 재시작
# 프론트엔드는 그대로 실행 중이면 OK
# 브라우저 새로고침 → 온보딩 → 보정 → 홈 (기기 2개 유지)
```

---

## 📂 데이터 저장 위치

### macOS
```
/Users/{사용자명}/.gazehome/calibrations/
├── gazehome.db          # SQLite DB
└── demo_user.pkl        # 보정 데이터
```

### 라즈베리파이
```
/home/pi/.gazehome/calibrations/
├── gazehome.db          # SQLite DB
└── demo_user.pkl        # 보정 데이터
```

---

## 🔍 DB 테이블 구조

### `users`
- `id`: Primary Key
- `username`: 사용자명 (기본값: "demo_user")

### `calibrations`
- `id`: Primary Key
- `user_id`: 외래키 → users(id)
- `calibration_file`: .pkl 파일 절대 경로
- `method`: 보정 방법 (nine_point, five_point)
- `created_at`: 생성 시간

### `devices`
- `id`: Primary Key
- `device_id`: LG 기기 ID (고유)
- `device_type`: 기기 타입 (예: AIR_CONDITIONER, AIR_PURIFIER)
- `alias`: 기기 별칭 (예: "에어컨1")
- `model_name`: 모델명
- `reportable`: 상태 조회 가능 여부
- `device_profile`: 기기 프로필 JSON
- `created_at`: 생성 시간

### `device_actions`
- `id`: Primary Key
- `device_id`: 외래키 → devices(device_id)
- `action_type`: 액션 타입 (예: Operation)
- `action_name`: 액션 이름 (예: airConOperationMode)
- `readable`: 읽기 가능 여부
- `writable`: 쓰기 가능 여부
- `value_type`: 값 타입
- `value_range`: 값 범위
- `created_at`: 생성 시간

---

## 💡 팁

### 빠른 디버깅
```bash
# DB 상태만 빠르게 확인
uv run check_db_status.py | grep "개"

# 보정 파일 직접 확인
ls -lh ~/.gazehome/calibrations/*.pkl

# DB 직접 쿼리 (sqlite3 필요)
sqlite3 ~/.gazehome/calibrations/gazehome.db "SELECT * FROM devices;"
```

### CI/CD 통합
```bash
# 테스트 전 자동 초기화
uv run reset_all_data.py <<< "y"

# 테스트 후 상태 확인
uv run check_db_status.py > db_status.log
```

---

## ❓ FAQ

**Q: 보정을 다시 하고 싶은데 기기는 그대로 두고 싶어요**  
A: `uv run reset_calibration.py` 사용

**Q: 기기 목록을 다시 가져오고 싶어요**  
A: `uv run reset_all_data.py` 사용 후 백엔드 재시작

**Q: DB가 어디에 있는지 모르겠어요**  
A: `uv run check_db_status.py` 실행하면 경로가 표시됩니다

**Q: 라즈베리파이에서도 동일한 방법인가요?**  
A: 네, 모든 스크립트가 동일하게 작동합니다. 경로만 `/home/pi/.gazehome/calibrations/`로 자동 변경됩니다.

**Q: 스크립트 실행 시 에러가 나요**  
A: 
1. 프로젝트 루트에서 실행하는지 확인
2. `uv sync` 또는 `pip install -e .` 실행
3. Python 경로 확인: `which python` 또는 `uv run python --version`
